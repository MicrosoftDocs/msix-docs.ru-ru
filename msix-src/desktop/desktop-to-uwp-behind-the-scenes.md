---
Description: В этой статье подробно рассматривается внутренняя работа моста для классических приложений.
title: Как устроен мост для классических приложений
ms.date: 04/25/2019
ms.topic: article
keywords: windows 10, uwp, msix
ms.assetid: a399fae9-122c-46c4-a1dc-a1a241e5547a
ms.localizationpriority: medium
ms.openlocfilehash: e077459447f51f7ff784e532a4793e2823272e32
ms.sourcegitcommit: 0412ba69187ce791c16313d0109a5d896141d44c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2019
ms.locfileid: "75303297"
---
# <a name="behind-the-scenes-of-your-packaged-desktop-application"></a>За сценой упакованного классического приложения

Эта статья содержит более подробные сведения о том, что происходит с файлами и записями реестра при создании пакета приложения Windows для классического приложения.

Основная цель современного пакета заключается в том, чтобы по мере возможности отделять состояние приложения от состояния системы, сохраняя совместимость с другими приложениями. В Windows 10 это достигается путем размещения приложения в пакете MSIX, а затем обнаружения и перенаправления некоторых изменений, внесенных в файловую систему и реестр во время выполнения.

Пакеты, создаваемые для настольного приложения, являются приложениями с полным доверием только для настольных систем и не являются виртуальными или изолированными. Это позволяет им взаимодействовать с другими приложениями точно так же, как это делают классические приложения.

## <a name="installation"></a>Установка

Пакеты приложения устанавливаются в папку *C:\Program Files\WindowsApps\имя_пакета*; исполняемый файл имеет имя вида *имя_приложение.exe*. Каждая папка пакета содержит манифест (с именем AppxManifest.xml), содержащий специальное пространство имен XML для упакованных приложений. Внутри этого файла манифеста находится элемент ```<EntryPoint>```, который указывает на приложение с полным доверием. При запуске этого приложения оно не выполняется в контейнере приложения, а выполняется от имени пользователя как обычно.

После развертывания пакета файлы помечаются как доступные только для чтения и блокируются операционной системой. Windows не позволяет запускать приложения, если в эти файлы внесены несанкционированные изменения.

## <a name="file-system"></a>Файловая система

ОПЕРАЦИОННАЯ система поддерживает различные уровни операций файловой системы для упакованных настольных приложений в зависимости от расположения папки.

### <a name="appdata-operations-on-windows-10-version-1903-and-later"></a>Операции AppData в Windows 10, версия 1903 и более поздние

Все вновь созданные файлы и папки в папке AppData пользователя (например, *c:\users\ user_name \AppData*) записываются в частном расположении для каждого пользователя, но во время выполнения они появятся в папке APPDATA. Это обеспечивает некоторую степень разделения состояния для артефактов, которые используются только самим приложением. Это позволяет системе очищать эти файлы при удалении приложения. Изменения в существующих файлах в папке AppData пользователя позволяют предотвратить более высокую степень совместимости и взаимодействия между приложениями и операционной системой. Это сокращает число файлов в файловой системе "Rot", поскольку операционная система осведомлена о каждом изменении файла или каталога, сделанных приложением. Разделение состояния также позволяет упакованным настольным приложениям выбирать, где не установлена упакованная версия того же приложения. Обратите внимание, что операционная система не поддерживает папку виртуальной файловой системы (VFS) для папки AppData пользователя.

### <a name="appdata-operations-on-windows-10-version-1809-and-earlier"></a>Операции AppData в Windows 10, версия 1809 и более ранние

Все операции записи в папку AppData пользователя (например, *c:\users\ user_name \AppData*), включая создание, удаление и обновление, копируются при записи в личное расположение на уровне пользователя или на уровне приложения. Это создает впечатление, что упакованное приложение изменяет реальную AppData, когда фактически изменяет закрытую копию. Перенаправляя операции записи таким образом, система может отслеживать все изменения, вносимые приложением в файлы. Это позволяет системе очищать эти файлы при удалении приложения, уменьшая тем самым системную «ROT» и предоставляя более качественное удаление приложений для пользователя.

### <a name="other-folders"></a>Другие папки

Помимо перенаправления AppData, хорошо известные папки Windows (system32, Program Files (x86) и т. д.) динамически объединяются с соответствующими каталогами в пакете приложения. В корне каждого пакета содержится папка с именем VFS. Все операции чтения каталогов или файлов в каталоге VFS во время выполнения объединяются с их системными эквивалентами. Например, приложение может содержать *C:\Program филес\виндовсаппс\ PACKAGE_NAME \vfs\systemx86\vc10.dll* в составе пакета приложения, но файл будет выглядеть как установленный в *C:\Windows\System32\vc10.dll*.  Это обеспечивает совместимость с классическими приложениями, которые могут ожидать, что файлы будут находиться не в пакете.

Операции записи в файлы и папки в пакете приложения не допускаются. Запись в файлы и папки, не входящие в пакет, пропускается операционной системой и разрешается при условии, что у пользователя есть разрешение.

### <a name="common-operations"></a>Типичные операции

В этой краткой справочной таблице показаны общие операции файловой системы и их обработка операционной системой.

| Действие | Результат | Пример |
| --- | --- | --- |
| Чтение или перечисление известного файла или папки Windows | Динамическое объединение *C:\Program Files\имя_пакета\VFS\известная_папка* с локальным системным эквивалентом. | Операция чтения *C:\Windows\System32* возвращает содержимое *C:\Windows\System32* плюс содержимое *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86*. |
| Запись в папке AppData | **Windows 10, версия 1903 и более поздние версии:** Новые файлы и папки, созданные в следующих каталогах, перенаправляются в частное расположение "на пользователя" для каждого пакета:<ul><li>Локальные</li><li>локал\микрософт</li><li>Roaming</li><li>роаминг\микрософт</li><li>Роаминг\микрософт\виндовс\старт Мену\програмс</li></ul>В ответ на команду открытия файла ОС сначала открывает файл из расположения "на пользователя" для каждого пакета. Если это расположение не существует, ОС попытается открыть файл из реальной папки AppData. Если файл открыт из реальной папки AppData, виртуализация для этого файла не выполняется. Удаление файлов в разделе AppData разрешено, если пользователь имеет разрешения.<p/><p/>**Windows 10, версия 1809 и более ранние версии:** Копирование при записи для каждого пользователя, расположенного на уровне приложения. | Папка AppData — это обычно *C:\Users\имя_пользователя\AppData*. |
| Запись внутри пакета | не разрешено; Пакет доступен только для чтения. | Операции записи внутри папки *C:\Program Files\WindowsApps\имя_пакета* не допускаются. |
| Запись за пределами пакета | Допускается, если у пользователя есть разрешения. | Операция записи в *C:\Windows\System32\foo.dll* допускается, если пакет не содержит файла *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86\foo.dll* и у пользователя есть разрешения. |

### <a name="packaged-vfs-locations"></a>Расположения, соответствующие расположениям в каталоге VFS пакета

В следующей таблице показано, где в системе для приложения создаются оверлеи файлов, поставляемых в составе пакета. Приложение воспримет эти файлы в перечисленных системных расположениях, если они находятся в перенаправленных расположениях в папке *C:\Program филес\виндовсаппс\ PACKAGE_NAME \вфс*. Расположения FOLDERID происходят от констант [**KNOWNFOLDERID**](https://msdn.microsoft.com/library/windows/desktop/dd378457.aspx).

Системное расположение | Расположение перенаправления (в разделе [PackageRoot] \ВФС\) | Действительно для следующих архитектур
 :--- | :--- | :---
FOLDERID_SystemX86 | SystemX86 | x86, amd64
FOLDERID_System | SystemX64 | amd64
FOLDERID_ProgramFilesX86 | ProgramFilesX86 | x86, amd6
FOLDERID_ProgramFilesX64 | ProgramFilesX64 | amd64
FOLDERID_ProgramFilesCommonX86 | ProgramFilesCommonX86 | x86, amd64
FOLDERID_ProgramFilesCommonX64 | ProgramFilesCommonX64 | amd64
FOLDERID_Windows | Windows | x86, amd64
FOLDERID_ProgramData | Common AppData | x86, amd64
FOLDERID_System\catroot | AppVSystem32Catroot | x86, amd64
FOLDERID_System\catroot2 | AppVSystem32Catroot2 | x86, amd64
FOLDERID_System\drivers\etc | AppVSystem32DriversEtc | x86, amd64
FOLDERID_System\driverstore | AppVSystem32Driverstore | x86, amd64
FOLDERID_System\logfiles | AppVSystem32Logfiles | x86, amd64
FOLDERID_System\spool | AppVSystem32Spool | x86, amd64

## <a name="registry"></a>Реестр

Пакеты приложений содержат файл registry.dat, который выступает в качестве логического эквивалента куста *HKLM\Software* в реальном реестре. Во время выполнения этот виртуальный реестр объединяет содержимое этого куста с собственным кустом системы, чтобы обеспечить их единообразное представление. Например, если registry.dat содержит только раздел «Foo», при чтении куста *HKLM\Software* во время выполнения создастся впечатление, что этот куст также содержит раздел «Foo» (в дополнение ко всем собственным разделам системы).

В состав пакета входят только разделы внутри куста *HKLM\Software*; разделы внутри куста *HKCU* или другие составляющие реестра к пакету не относятся. Операции записи в разделы или значения в пакете не допускаются. Запись в ключи или значения, не входящие в пакет, разрешена при условии, что пользователь имеет разрешение.

Все операции записи внутри куста HKCU копируются при записи в расположение, отдельное для каждого пользователя и каждого приложения. Как правило, при удалении приложения не удается очистить раздел *HKEY_CURRENT_USER*, потому что данные реестра для вышедших из системы пользователей размонтированы и недоступны.

Все операции записи сохраняются во время обновления пакета и удаляются только при полном удалении приложения.

### <a name="common-operations"></a>Типичные операции

В этой краткой справочной таблице показаны общие операции реестра и их обработка операционной системой.

Действие | Результат | Пример
:--- | :--- | :---
Чтение или перечисление куста *HKLM\Software* | Динамическое объединение куста пакета с локальным системным эквивалентом. | Например, если registry.dat содержит только раздел «Foo», операция чтения куста *HKLM\Software* во время выполнения возвратит содержимое и *HKLM\Software*, и *HKLM\Software\Foo*.
Запись внутри куста HKCU | Копирование при записи в закрытое расположение, отдельное для каждого пользователя и каждого приложения. | (Аналогично AppData для файлов.)
Запись внутри пакета | не разрешено; Пакет доступен только для чтения. | Операции записи внутри куста *HKLM\Software* не допускаются, если в кусте пакета существует соответствующая пара «раздел-значение».
Запись за пределами пакета | Игнорируется операционной системой. Допускается, если у пользователя есть разрешения. | Операции записи внутри куста *HKLM\Software* допускаются при условии, что в кусте пакета нет соответствующей пары «раздел-значение», и что у пользователя есть соответствующие разрешения на доступ.

## <a name="uninstallation"></a>Удаление

При удалении пакета пользователем удаляются все файлы и папки, расположенные в папке *C:\Program филес\виндовсаппс\ PACKAGE_NAME* , а также перенаправленные записи в AppData или реестр, записанные в процессе упаковки.

## <a name="next-steps"></a>Дальнейшие действия

Есть вопросы? Задайте их на Stack Overflow. Наша команда следит за этими [тегами](https://stackoverflow.com/questions/tagged/project-centennial+or+desktop-bridge). Вы также можете задать нам вопросы [здесь](https://social.msdn.microsoft.com/Forums/en-US/home?filter=alltypes&sort=relevancedesc&searchTerm=%5BDesktop%20Converter%5D).
