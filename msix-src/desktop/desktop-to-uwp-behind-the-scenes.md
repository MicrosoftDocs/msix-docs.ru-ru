---
Description: В этой статье подробно рассматривается внутренняя работа моста для классических приложений.
title: Как работает Desktop Bridge
ms.date: 04/25/2019
ms.topic: article
keywords: windows 10, uwp, msix
ms.assetid: a399fae9-122c-46c4-a1dc-a1a241e5547a
ms.localizationpriority: medium
ms.openlocfilehash: 8e7a435ca3394152cedaafa01033e5f510f6d8f3
ms.sourcegitcommit: 25811dea7b2b4daa267bbb2879ae9ce3c530a44a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67828789"
---
# <a name="behind-the-scenes-of-your-packaged-desktop-application"></a>За кулисами упакованные приложения рабочего стола

Эта статья содержит более подробные сведения, что происходит для файлов и реестра, при создании пакета приложения Windows для своего настольного приложения.

Основная цель современных пакета является отделение состояние приложения от состояния системы, насколько это возможно, сохраняя совместимость с другими приложениями. Windows 10 это достигается путем размещения приложения внутри пакета универсальной платформы Windows (UWP) и затем определения и перенаправления некоторые изменения, которые оно отправляет в файловой системе и реестре во время выполнения.

Пакеты, созданные для своего настольного приложения — это приложения только для настольных систем, полного доверия и не виртуализованный или изолированной. Это позволяет им взаимодействовать с другими приложениями точно так же, как это делают классические приложения.

## <a name="installation"></a>Установка

Пакеты приложения устанавливаются в папку *C:\Program Files\WindowsApps\имя_пакета*; исполняемый файл имеет имя вида *имя_приложение.exe*. Каждая папка пакета содержит манифест (с именем AppxManifest.xml), содержащий специальное пространство имен XML для упакованных приложений. Внутри этого файла манифеста находится элемент ```<EntryPoint>```, который указывает на приложение с полным доверием. При запуске этого приложения, она не может быть выполнена внутри приложения в контейнере, но вместо этого он выполняется как пользователь, как обычно.

После развертывания пакета файлы помечаются как доступные только для чтения и блокируются операционной системой. Windows не позволяет запускать приложения, если в эти файлы внесены несанкционированные изменения.

## <a name="file-system"></a>Файловая система

Операционная система поддерживает разные уровни операции файловой системы для упакованных приложений рабочего стола, в зависимости от местоположения папки.

### <a name="appdata-operations-on-windows-10-version-1903-and-later"></a>AppData операций в Windows 10, версия 1903 и более поздние версии

Все созданные файлы и папки в папку AppData пользователя (например, *C:\Users\user_name\AppData*) записываются в закрытый каждого пользователя, расположение на уровне приложения, но объединены во время выполнения в их реальному местоположению AppData. Это обеспечивает определенную степень разделения состояние для артефактов, которые используются только самим приложением, и это позволяет системе для очистки этих файлов при удалении приложения. Изменения в существующие файлы в папке AppData пользователя может предотвратить более высокую степень совместимости и взаимодействия между приложениями и ОС. Это уменьшает rot «файловая система», так как операционная система учитывает изменения каждого файла или папки, произведенным приложением. Состояния разделение также позволяет упакованные приложения рабочего стола для получения там, где остановились не упакованные версии того же приложения. Обратите внимание на то, что операционная система не поддерживает папку виртуальной файловой системы (VFS) для папки AppData.

### <a name="appdata-operations-on-windows-10-version-1809-and-earlier"></a>AppData операций в Windows 10, версия 1809 и более ранних версий

Все операции записи в папку AppData пользователя (например, *C:\Users\user_name\AppData*), включая create, delete и update, копируются на записи закрытый каждого пользователя, расположение на уровне приложения. Это создает впечатление, что упакованного приложения редактируется реальных AppData, когда он фактически изменяет частную копию. Перенаправляя операции записи таким образом, система может отслеживать все изменения, вносимые приложением в файлы. Это позволяет системе для очистки этих файлов при удалении приложения, таким образом уменьшая rot «system», а предоставление лучше удалением приложений пользователем для пользователя.

### <a name="other-folders"></a>Другие папки

В дополнение к перенаправление AppData, хорошо известных папок Windows (System32, Program Files (x86) т. д) динамически объединяются с соответствующие каталоги в пакете приложения. В корне каждого пакета содержится папка с именем VFS. Все операции чтения каталогов или файлов в каталоге VFS во время выполнения объединяются с их системными эквивалентами. Например, приложение может содержать *C:\Program Files\WindowsApps\package_name\VFS\SystemX86\vc10.dll* как часть пакета приложения, но файл будет выглядеть во *C:\Windows\System32\ vc10.dll*.  Это обеспечивает совместимость с классическими приложениями, которые могут ожидать, что файлы будут находиться не в пакете.

Операции записи в файлы и папки в пакете приложения не допускаются. Операции записи к файлам и папкам, которые не являются частью пакета обрабатываются Операционной системой и допускаются до тех пор, пока пользователь имеет разрешение.

### <a name="common-operations"></a>Типичные операции

Эта таблица краткой ссылки показаны общие операции файловой системы и как операционная система обрабатывает их.

| Операция | Результат | Пример |
| --- | --- | --- |
| Чтение или перечисление известного файла или папки Windows | Динамическое объединение *C:\Program Files\имя_пакета\VFS\известная_папка* с локальным системным эквивалентом. | Операция чтения *C:\Windows\System32* возвращает содержимое *C:\Windows\System32* плюс содержимое *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86*. |
| Запись в папке AppData | **Windows 10, версия 1903 и более поздних версий:** Новые файлы и папки, созданные в следующих каталогах перенаправляются на каждого пользователя, расположение закрытого-package:<ul><li>Локальная</li><li>Local\Microsoft</li><li>Roaming (Роуминг)</li><li>Roaming\Microsoft</li><li>Roaming\Microsoft\Windows\Start Menu\Programs</li></ul>В ответ на команду Открыть файл операционной системы будет открыть файл из пользователя, каждому пакету расположение сначала. Если это расположение не существует, операционная система будет пытаться открыть файл из их реальному местоположению AppData. Если файл открыт из их реальному местоположению AppData, происходит без виртуализации для этого файла. Удаляет файл в разделе AppData разрешены, если у пользователя есть разрешения.<p/><p/>**Windows 10, версия 1809 и более ранних версий:** Копирование при записи в расположение, отдельное для каждого пользователя и каждого приложения. | Папка AppData — это обычно *C:\Users\имя_пользователя\AppData*. |
| Запись внутри пакета | Не допускается. Пакет доступен только для чтения. | Операции записи внутри папки *C:\Program Files\WindowsApps\имя_пакета* не допускаются. |
| Запись за пределами пакета | Допускается, если у пользователя есть разрешения. | Операция записи в *C:\Windows\System32\foo.dll* допускается, если пакет не содержит файла *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86\foo.dll* и у пользователя есть разрешения. |

### <a name="packaged-vfs-locations"></a>Расположения, соответствующие расположениям в каталоге VFS пакета

В следующей таблице показано, где в системе для приложения создаются оверлеи файлов, поставляемых в составе пакета. Приложение будет воспринимать эти файлы должны находиться в списке системных папок, когда на самом деле они в перенаправленных папках внутри *C:\Program Files\WindowsApps\package_name\VFS*. Расположения FOLDERID происходят от констант [**KNOWNFOLDERID**](https://msdn.microsoft.com/library/windows/desktop/dd378457.aspx).

Системное расположение | Перенаправлено расположение (в разделе [PackageRoot] \VFS\) | Действительно для следующих архитектур
 :--- | :--- | :---
FOLDERID_SystemX86 | SystemX86 | x86, amd64
FOLDERID_System | SystemX64 | amd64
FOLDERID_ProgramFilesX86 | ProgramFilesX86 | x86, amd6
FOLDERID_ProgramFilesX64 | ProgramFilesX64 | amd64
FOLDERID_ProgramFilesCommonX86 | ProgramFilesCommonX86 | x86, amd64
FOLDERID_ProgramFilesCommonX64 | ProgramFilesCommonX64 | amd64
FOLDERID_Windows | Windows | x86, amd64
FOLDERID_ProgramData | Common AppData | x86, amd64
FOLDERID_System\catroot | AppVSystem32Catroot | x86, amd64
FOLDERID_System\catroot2 | AppVSystem32Catroot2 | x86, amd64
FOLDERID_System\drivers\etc | AppVSystem32DriversEtc | x86, amd64
FOLDERID_System\driverstore | AppVSystem32Driverstore | x86, amd64
FOLDERID_System\logfiles | AppVSystem32Logfiles | x86, amd64
FOLDERID_System\spool | AppVSystem32Spool | x86, amd64

## <a name="registry"></a>Реестр

Пакеты приложений содержат файл registry.dat, который выступает в качестве логического эквивалента куста *HKLM\Software* в реальном реестре. Во время выполнения этот виртуальный реестр объединяет содержимое этого куста с собственным кустом системы, чтобы обеспечить их единообразное представление. Например, если registry.dat содержит только раздел «Foo», при чтении куста *HKLM\Software* во время выполнения создастся впечатление, что этот куст также содержит раздел «Foo» (в дополнение ко всем собственным разделам системы).

В состав пакета входят только разделы внутри куста *HKLM\Software*; разделы внутри куста *HKCU* или другие составляющие реестра к пакету не относятся. Операции записи в разделы или значения в пакете не допускаются. Записывает ключи или значения не допускаются в пакете, до тех пор, пока пользователь имеет разрешение.

Все операции записи внутри куста HKCU копируются при записи в расположение, отдельное для каждого пользователя и каждого приложения. Как правило, при удалении приложения не удается очистить раздел *HKEY_CURRENT_USER*, потому что данные реестра для вышедших из системы пользователей размонтированы и недоступны.

Все операции записи хранятся во время обновления пакетов и удалено, только когда приложение удаляется полностью.

### <a name="common-operations"></a>Типичные операции

Эта таблица краткой ссылки показаны распространенные операции с реестром и как операционная система обрабатывает их.

Операция | Результат | Пример
:--- | :--- | :---
Чтение или перечисление куста *HKLM\Software* | Динамическое объединение куста пакета с локальным системным эквивалентом. | Например, если registry.dat содержит только раздел «Foo», операция чтения куста *HKLM\Software* во время выполнения возвратит содержимое и *HKLM\Software*, и *HKLM\Software\Foo*.
Запись внутри куста HKCU | Копирование при записи в закрытое расположение, отдельное для каждого пользователя и каждого приложения. | (Аналогично AppData для файлов.)
Запись внутри пакета | Не допускается. Пакет доступен только для чтения. | Операции записи внутри куста *HKLM\Software* не допускаются, если в кусте пакета существует соответствующая пара «раздел-значение».
Запись за пределами пакета | Игнорировать операционной системы. Допускается, если у пользователя есть разрешения. | Операции записи внутри куста *HKLM\Software* допускаются при условии, что в кусте пакета нет соответствующей пары «раздел-значение», и что у пользователя есть соответствующие разрешения на доступ.

## <a name="uninstallation"></a>Удаление

При удалении пакета пользователем файлы и папки, расположенный в *C:\Program Files\WindowsApps\package_name* удаляются, а также все перенаправленные записи AppData или реестра, захваченных в ходе процесс упаковки.

## <a name="next-steps"></a>Следующие шаги

**Найдите ответы на ваши вопросы**

Есть вопросы? Задайте их на Stack Overflow. Наша команда следит за этими [тегами](https://stackoverflow.com/questions/tagged/project-centennial+or+desktop-bridge). Вы также можете задать нам вопросы [здесь](https://social.msdn.microsoft.com/Forums/en-US/home?filter=alltypes&sort=relevancedesc&searchTerm=%5BDesktop%20Converter%5D).

**Отправить отзыв или предложения по функциям**

См. раздел [UserVoice](https://wpdev.uservoice.com/forums/110705-universal-windows-platform/category/161895-desktop-bridge-centennial)