---
Description: Если у вас есть проект упаковки в Visual Studios и вы хотите применить платформу поддержки пакетов
title: Применение платформы поддержки пакетов в Visual Studio
ms.date: 05/14/2020
ms.topic: article
keywords: windows 10, uwp
ms.localizationpriority: medium
ms.openlocfilehash: f006bb54348415259aae596d7fe5fe0328115394
ms.sourcegitcommit: 8d6bc53d5f5ae80d9ce191fe81660407e9f11e0e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/15/2020
ms.locfileid: "83430416"
---
# <a name="apply-package-support-framework-in-visual-studio"></a>Применение платформы поддержки пакетов в Visual Studio
Платформа поддержки пакетов (ПСФ) — это [проект с открытым исходным кодом](https://github.com/Microsoft/MSIX-PackageSupportFramework/) , который позволяет применять исправления к существующему классическому приложению. ПСФ позволяет приложению работать в упакованном формате MSIX без изменения кода. Платформа поддержки пакетов помогает настроить приложения в соответствии с требованиями современных сред выполнения.

В следующих разделах мы рассмотрим, как создать новый проект Visual Studio, включить в решение платформу поддержки пакетов и создать исправления среды выполнения.

## <a name="step-1-create-a-package-solution-in-visual-studio"></a>Шаг 1. Создание пакета решения в Visual Studio
В Visual Studio создайте новое **решение Visual Studio с пустым решением**. Включите все проекты приложений в созданное **пустое решение**. 

## <a name="step-2-add-a-packaging-project"></a>Шаг 2. Добавление проекта упаковки

Если у вас еще нет **проекта упаковки приложений Windows**, создайте его и добавьте в решение. Создайте **проект упаковки приложений Windows универсальной > Visual C# > Windows** и добавьте его в созданное решение.

Дополнительные сведения о проекте упаковки приложений Windows см. в статье [Упаковка приложения с помощью Visual Studio](../desktop/desktop-to-uwp-packaging-dot-net.md).

В **Обозреватель решений**щелкните проект упаковки правой кнопкой мыши, выберите **изменить**, а затем добавьте в конец файла проекта:

```xml
<Target Name="PSFRemoveSourceProject" AfterTargets="ExpandProjectReferences" BeforeTargets="_ConvertItems">
<ItemGroup>
  <FilteredNonWapProjProjectOutput Include="@(_FilteredNonWapProjProjectOutput)">
  <SourceProject Condition="'%(_FilteredNonWapProjProjectOutput.SourceProject)'=='<Runtime fix project name>'" />
  </FilteredNonWapProjProjectOutput>
  <_FilteredNonWapProjProjectOutput Remove="@(_FilteredNonWapProjProjectOutput)" />
  <_FilteredNonWapProjProjectOutput Include="@(FilteredNonWapProjProjectOutput)" />
</ItemGroup>
</Target>
```

## <a name="step-3-add-project-for-the-runtime-fix"></a>Шаг 3. Добавление проекта для исправления среды выполнения

Добавьте в решение новый проект **библиотеки динамической компоновки (DLL) Visual C++ > Windows >** .

Затем щелкните правой кнопкой мыши этот проект и выберите пункт **Свойства**.

На странице свойств откройте страницу **Свойства конфигурации — > C/C++-> language > язык C++ Standard** . Затем в раскрывающемся меню выберите ISO C++ 17 Standard (/std: c++ 17).

Щелкните проект правой кнопкой мыши и в контекстном меню выберите пункт **Управление пакетами NuGet** . Убедитесь, что для параметра **источник пакета** задано значение **все** или **NuGet.org**.

Щелкните значок параметров рядом с этим полем.

Выполните поиск пакетов NuGet для **ПСФ**, а затем установите **Microsoft. паккажесуппортфрамеворк** для этого проекта.

![пакет nuget](images/psf-package.png)

## <a name="step-4-add-a-project-that-starts-the-psf-launcher-executable"></a>Шаг 4. Добавление проекта, запускающего исполняемый файл запуска ПСФ
Добавьте в решение новый **проект Visual C++-> General > Empty** .

Выполните следующие шаги: 
1. Щелкните правой кнопкой мыши этот проект, а затем в контекстном меню выберите пункт **Управление пакетами NuGet** . Убедитесь, что для параметра **источник пакета** задано значение **все** или **NuGet.org**.
1. Щелкните значок параметров рядом с этим полем.
1. Выполните поиск пакетов NuGet для ПСФ, а затем установите Microsoft. Паккажесуппортфрамеворк для этого проекта.

Откройте **страницы свойств** проекта и на странице **Общие** параметры задайте для свойства **имя целевого объекта** значение ``PSFLauncher32`` или в ``PSFLauncher64`` зависимости от архитектуры приложения.

Добавьте ссылку проекта в проект исправления среды выполнения в решении.

Щелкните ссылку правой кнопкой мыши, а затем в окне **Свойства** примените эти значения.

| Свойство | Значение |
|-------|-----------|
| Копировать локально | True |
| Копировать локальные вспомогательные сборки | True |
| Выходные данные ссылочной сборки | True |
| Компоновать зависимости библиотек | False |
| Связывание входных данных зависимостей библиотеки | False |

## <a name="step-5-configure-the-packaging-project"></a>Шаг 5. Настройка проекта упаковки

Чтобы настроить проект упаковки, выполните следующие действия. 
1. В проекте упаковки щелкните правой кнопкой мыши папку **приложения** и выберите в раскрывающемся меню пункт **Добавить ссылку** .
1. Выберите проект средства запуска ПСФ и проект приложения рабочего стола, а затем нажмите кнопку **ОК** .
1. Выберите и **средство запуска ПСФ** , и проект **классического приложения** , а затем нажмите кнопку ОК. Если исходный код приложения недоступен, выберите только проект средства запуска ПСФ.
1. В узле **приложения** щелкните правой кнопкой мыши приложение ПСФ Launcher и выберите пункт **задать в качестве точки входа**.

Добавьте файл с именем ``config.json`` в проект упаковки, а затем скопируйте и вставьте следующий текст JSON в файл. Задайте для свойства **действие пакета** значение **содержимое**.

```json
{
    "applications": [
        {
            "id": "",
            "executable": "",
            "workingDirectory": ""
        }
    ],
    "processes": [
        {
            "executable": "",
            "fixups": [
                {
                    "dll": "",
                    "config": {
                    }
                }
            ]
        }
    ]
}
```

Укажите значение для каждого ключа. Используйте эту таблицу в качестве справочника.

| Массив | key | Значение |
|-------|-----------|-------|
| веб-масштабированием; | id |  Используйте значение `Id` атрибута `Application` элемента в манифесте пакета. |
| веб-масштабированием; | исполняемый файл | Относительный путь пакета к исполняемому файлу, который необходимо запустить. В большинстве случаев это значение можно получить из файла манифеста пакета, прежде чем изменять его. Это значение `Executable` атрибута `Application` элемента. |
| веб-масштабированием; | workingDirectory | Используемых Путь относительно пакета, используемый в качестве рабочего каталога запускаемого приложения. Если это значение не задано, операционная система использует каталог в `System32` качестве рабочего каталога приложения. |
| процессы | исполняемый файл | В большинстве случаев это будет имя, указанное `executable` выше, с удаленным путем и расширением файла. |
| исправлений | Файл DLL. | Относительный путь пакета к библиотеке DLL адресной привязки для загрузки. |
| исправлений | config | Используемых Определяет, как ведет себя библиотека DLL адресной привязки. Точный формат этого значения зависит от способа исправления, так как каждая адресная привязка может интерпретировать этот «большой двоичный объект». |

По завершении ``config.json`` файл будет выглядеть примерно так.

```json
{
  "applications": [
    {
      "id": "DesktopApplication",
      "executable": "DesktopApplication/WinFormsDesktopApplication.exe",
      "workingDirectory": "WinFormsDesktopApplication"
    }
  ],
  "processes": [
    {
      "executable": ".*App.*",
      "fixups": [ { "dll": "RuntimeFix.dll" } ]
    }
  ]
}

```

>[!NOTE]
> `applications`Ключи, `processes` и `fixups` являются массивами. Это означает, что можно использовать файл config. JSON для указания более чем одного DLL приложения, процесса и адресной привязки.

### <a name="debug-a-runtime-fix"></a>Отладка исправления среды выполнения

В Visual Studio нажмите клавишу F5, чтобы запустить отладчик.  Первое, что начинается, — это приложение ПСФ Launcher, которое, в свою очередь, запускает целевое классическое приложение.  Чтобы выполнить отладку целевого настольного приложения, необходимо вручную присоединиться к процессу настольного приложения, выбрав **отладка >присоединить к процессу**, а затем выбрав процесс приложения. Чтобы разрешить отладку приложения .NET с помощью встроенной библиотеки DLL с исправлением среды выполнения, выберите управляемые и машинные типы кода (Отладка в смешанном режиме).  

Можно задать точки останова рядом с строками кода в коде приложения для настольных систем и в проекте исправления среды выполнения. Если у вас нет исходного кода для приложения, вы сможете устанавливать точки останова только рядом с строками кода в проекте исправления среды выполнения.